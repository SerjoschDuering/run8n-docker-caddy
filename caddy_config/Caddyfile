run8n.xyz {
    reverse_proxy n8n:5678 {
        flush_interval -1
    }
}

nocodb.run8n.xyz {
    reverse_proxy nocodb:8080
}

siyuan.run8n.xyz {
    reverse_proxy siyuan:6806 {
    }
}

supabase.run8n.xyz {
    reverse_proxy supabase_kong:8000
}

windmill.run8n.xyz {
    reverse_proxy windmill_server:8000
}

# Static Sites - Serve from /srv with security
sites.run8n.xyz {
    root * /srv

    # Block access to hidden files and sensitive directories
    @blocked {
        path /.git/* /.git* /.env* /.*
    }
    respond @blocked 404

    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
    }

    # Try files first, then directory listing
    file_server browse
}

# MCP Servers - Path-based routing
# Pattern: mcp.run8n.xyz/{name} â†’ {name}-mcp:3000
mcp.run8n.xyz {
    # SiYuan MCP Server
    handle /siyuan* {
        reverse_proxy siyuan-mcp:3000
    }

    # Add more MCP servers here as you deploy them
    # Example:
    # handle /notion* {
    #     reverse_proxy notion-mcp:3000
    # }

    # Root path - info page
    handle / {
        respond "MCP Gateway - Available servers: /siyuan" 200
    }

    # 404 for unknown paths
    handle {
        respond "MCP Server not found" 404
    }
}

# ===========================================
# DASHBOARD STACK - Single Password Protection
# ===========================================

# ONE password protects everything: Homarr, Netdata, Dozzle, Filebrowser
# Generate hash on server: docker exec caddy caddy hash-password --plaintext "your-password"

dashboard.run8n.xyz {
    # Require authentication for ALL routes
    basicauth {
        admin JDJhJDE0JGJXd0c5Y3lGdC5oZ3RUTmRCSlRVaS5tUzFJeU5DQklLaDZLQnRhbGRtRHRRa3IzSE5NcE5l
    }

    # Server Monitoring - Netdata
    handle /monitor* {
        uri strip_prefix /monitor
        reverse_proxy netdata:19999
    }

    # Container Logs - Dozzle
    handle /logs* {
        uri strip_prefix /logs
        reverse_proxy dozzle:8080
    }

    # File Browser
    handle /files* {
        uri strip_prefix /files
        reverse_proxy filebrowser:80
    }

    # Main Dashboard - Homarr (root)
    handle {
        reverse_proxy homarr:3000
    }
}

