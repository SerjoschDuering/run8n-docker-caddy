run8n.xyz {
    reverse_proxy n8n:5678 {
        flush_interval -1
    }
}

nocodb.run8n.xyz {
    reverse_proxy nocodb:8080
}

siyuan.run8n.xyz {
    reverse_proxy siyuan:6806 {
    }
}

supabase.run8n.xyz {
    reverse_proxy supabase_kong:8000
}

# ===========================================
# GOTRUE AUTH SERVICE
# ===========================================
# Standalone authentication for your apps
# Supports: Email/password, Google, GitHub, Discord OAuth

auth.run8n.xyz {
    # CORS headers for cross-origin requests from your apps
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Accept"
        Access-Control-Max-Age 86400
    }

    # Handle preflight OPTIONS requests
    @options method OPTIONS
    respond @options 204

    # Proxy to GoTrue
    reverse_proxy gotrue:9999
}

windmill.run8n.xyz {
    reverse_proxy windmill_server:8000
}

# ===========================================
# SOKETI REAL-TIME WEBSOCKET SERVER
# ===========================================
# Pusher-compatible WebSocket server for real-time features
# Client: wss://realtime.run8n.xyz

realtime.run8n.xyz {
    # CORS headers for WebSocket connections
    header {
        Access-Control-Allow-Origin *
        Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, Accept"
        Access-Control-Max-Age 86400
    }

    # Handle preflight OPTIONS requests
    @options method OPTIONS
    respond @options 204

    # WebSocket proxy configuration
    reverse_proxy soketi:6001 {
        # Required for WebSocket upgrade
        header_up Upgrade {http.request.header.Upgrade}
        header_up Connection {http.request.header.Connection}

        # Preserve client IP
        header_up X-Real-IP {http.request.remote.host}
        header_up X-Forwarded-For {http.request.remote.host}
        header_up X-Forwarded-Proto {http.request.scheme}

        # WebSocket timeouts
        flush_interval -1
    }
}

# ===========================================
# QDRANT VECTOR DATABASE
# ===========================================
# Protected with basic authentication
# Generate password hash: docker exec caddy caddy hash-password --plaintext "your-password"

qdrant.run8n.xyz {
    # Basic authentication (same password as dashboard for simplicity)
    # TODO: Generate separate hash for qdrant
    basic_auth * {
        admin $2a$14$VA488pOUSVuGi/Rq48s5tuRSmo28rZRXjKeAORdj4TELNJ54kPRMy
    }

    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        Referrer-Policy strict-origin-when-cross-origin
        -Server
    }

    # Reverse proxy to Qdrant
    reverse_proxy qdrant:6333 {
        header_up X-Real-IP {http.request.remote.host}
        header_up X-Forwarded-For {http.request.remote.host}
        header_up X-Forwarded-Proto {http.request.scheme}
    }
}

# Static Sites - Serve from /srv with security
sites.run8n.xyz {
    root * /srv

    # Block access to hidden files and sensitive directories
    @blocked {
        path /.git/* /.git* /.env* /.*
    }
    respond @blocked 404

    # Security headers
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
        -Server
    }

    # Try files first, then directory listing
    file_server browse
}

# MCP Servers - Path-based routing
# Pattern: mcp.run8n.xyz/{name} â†’ {name}-mcp:3000
mcp.run8n.xyz {
    # SiYuan MCP Server
    handle /siyuan* {
        uri strip_prefix /siyuan
        reverse_proxy siyuan-mcp:3000 {
            header_up X-SiYuan-Token {header.X-SiYuan-Token}
            header_up X-SiYuan-URL {header.X-SiYuan-URL}
            header_up X-SiYuan-Credentials {header.X-SiYuan-Credentials}
            flush_interval -1
        }
    }

    # Add more MCP servers here as you deploy them
    # Example:
    # handle /notion* {
    #     reverse_proxy notion-mcp:3000
    # }

    # Root path - info page
    handle / {
        respond "MCP Gateway - Available servers: /siyuan" 200
    }

    # 404 for unknown paths
    handle {
        respond "MCP Server not found" 404
    }
}

# ===========================================
# DASHBOARD STACK - Single Password Protection
# ===========================================

# ONE password protects everything: Homarr, Netdata, Dozzle, Filebrowser
# Generate hash on server: docker exec caddy caddy hash-password --plaintext "your-password"

dashboard.run8n.xyz {
    # Require authentication for ALL routes
    basic_auth * {
        admin $2a$14$VA488pOUSVuGi/Rq48s5tuRSmo28rZRXjKeAORdj4TELNJ54kPRMy
    }

    # Server Monitoring - Netdata
    handle /monitor* {
        uri strip_prefix /monitor
        reverse_proxy netdata:19999
    }

    # Container Logs - Dozzle
    handle /logs* {
        reverse_proxy dozzle:8080
    }

    # File Browser
    handle /files* {
        reverse_proxy filebrowser:80
    }

    # Main Dashboard - Homarr (root)
    handle {
        reverse_proxy homarr:3000
    }
}

